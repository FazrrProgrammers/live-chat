<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Chat Publik (LocalStorage)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 20px auto;
    padding: 10px;
    background: #f4f6f8;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }
  #chat {
    border: 1px solid #ddd;
    height: 350px;
    padding: 10px;
    overflow-y: auto;
    background: #fff;
    border-radius: 6px;
    margin-bottom: 10px;
  }
  .message {
    margin-bottom: 8px;
    padding: 6px 12px;
    border-radius: 12px;
    max-width: 80%;
    word-wrap: break-word;
  }
  .message.user {
    background-color: #cce5ff;
    align-self: flex-end;
  }
  .message.other {
    background-color: #e2e3e5;
    align-self: flex-start;
  }
  .message strong {
    display: block;
    font-size: 0.85em;
    margin-bottom: 3px;
    color: #333;
  }
  #inputForm, #nameForm {
    display: flex;
    gap: 10px;
  }
  input[type="text"] {
    flex: 1;
    padding: 8px 12px;
    font-size: 16px;
    border-radius: 20px;
    border: 1px solid #ccc;
  }
  button {
    padding: 8px 18px;
    border: none;
    background-color: #007bff;
    color: white;
    border-radius: 20px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  button:hover {
    background-color: #0056b3;
  }
  #chatContainer {
    display: flex;
    flex-direction: column;
  }
</style>
</head>
<body>

<div id="nameContainer">
  <h2>Masukkan Nama Anda</h2>
  <form id="nameForm">
    <input type="text" id="nameInput" placeholder="Nama kamu..." autocomplete="off" required />
    <button type="submit">Mulai Chat</button>
  </form>
</div>

<div id="chatContainer" style="display:none;">
  <h2>Live Chat Publik</h2>
  <div id="chat"></div>
  <form id="inputForm">
    <input type="text" id="inputMessage" placeholder="Ketik pesan..." autocomplete="off" required />
    <button type="submit">Kirim</button>
  </form>
</div>

<script>
  const nameContainer = document.getElementById('nameContainer');
  const chatContainer = document.getElementById('chatContainer');
  const nameForm = document.getElementById('nameForm');
  const nameInput = document.getElementById('nameInput');

  const chat = document.getElementById('chat');
  const inputForm = document.getElementById('inputForm');
  const inputMessage = document.getElementById('inputMessage');

  // Simpan chat dan nama di localStorage
  const STORAGE_KEY = 'public_live_chat_messages';
  const STORAGE_NAME = 'public_live_chat_name';

  // Load nama dari localStorage jika ada
  let userName = localStorage.getItem(STORAGE_NAME);

  // Load chat messages dari localStorage (array of objects {name, text})
  let messages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

  function saveMessages() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  }

  function addMessageToDOM(msgObj) {
    const div = document.createElement('div');
    div.classList.add('message');
    // Jika pengirim sama dengan userName, tampilkan beda style
    if (msgObj.name === userName) {
      div.classList.add('user');
    } else {
      div.classList.add('other');
    }
    div.innerHTML = `<strong>${escapeHTML(msgObj.name)}</strong>${escapeHTML(msgObj.text)}`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  // Escape HTML untuk keamanan
  function escapeHTML(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Tampilkan semua pesan dari localStorage
  function renderMessages() {
    chat.innerHTML = '';
    messages.forEach(addMessageToDOM);
  }

  // Jika sudah ada nama tersimpan, langsung tampil chat
  if (userName) {
    nameContainer.style.display = 'none';
    chatContainer.style.display = 'block';
    renderMessages();
  }

  // Submit nama
  nameForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = nameInput.value.trim();
    if (!name) return alert('Nama harus diisi!');
    userName = name;
    localStorage.setItem(STORAGE_NAME, userName);
    nameContainer.style.display = 'none';
    chatContainer.style.display = 'block';
    renderMessages();
  });

  // Submit pesan
  inputForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const text = inputMessage.value.trim();
    if (!text) return;
    const msgObj = { name: userName, text: text };
    messages.push(msgObj);
    saveMessages();
    addMessageToDOM(msgObj);
    inputMessage.value = '';
  });
</script>

</body>
</html>
